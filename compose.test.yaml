services:
  mongodb:
    image: mongo:6.0.13
    networks:
      - cdp-tenant
    ports:
      - "27018:27017"
    volumes:
      - mongodb-test-data:/data

  ai-defra-search-agent:
    build:
      target: development
    image: ai-defra-search-agent-development
    container_name: ai-defra-search-agent-test
    entrypoint: uv run task test
    depends_on:
      mongodb:
        condition: service_started
    env_file:
      - path: .env
        required: false
    environment:
      AWS_REGION: ${AWS_REGION:-eu-central-1}
      PORT: ${PORT:-8086}
      MONGO_URI: ${MONGO_URI:-mongodb://mongodb:27017/}
      HOST: ${HOST:-0.0.0.0}
      LOCALSTACK_URL: ${LOCALSTACK_URL:-http://localstack:4566}
      AWS_BEDROCK_DEFAULT_GENERATION_MODEL: 'Geni AI 3.5'
      AWS_BEDROCK_AVAILABLE_GENERATION_MODELS: '[{"modelId": "geni-ai-3.5", "name": "Geni AI 3.5", "description": "A powerful conversational AI model suitable for a wide range of tasks.", "bedrockModelId": "geni-ai-3.5"}, {"modelId": "geni-ai-4", "name": "Geni AI 4", "description": "An advanced conversational AI model with enhanced understanding and generation capabilities.", "bedrockModelId": "geni-ai-4"}]'
    volumes:
      - ./app/:/home/nonroot/app
      - ./tests/:/home/nonroot/tests
      - ./coverage:/home/nonroot/coverage:rw
      - ./pytest.ini:/home/nonroot/pytest.ini:ro
    networks:
      - cdp-tenant

volumes:
  mongodb-test-data: